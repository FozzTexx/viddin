#!/bin/sh
#
# Copyright 2015 by Chris Osborn <fozztexx@fozztexx.com>
#
# This file is part of viddin.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License at <http://www.gnu.org/licenses/> for
# more details.

while [ $# -gt 0 -a `expr substr "${1:-empty}" 1 2` = "--" ] ; do
    case "$1" in
	--normalize)
	    NORMALIZE=1
	    shift
	    ;;
	--volume)
	    ADJFLAGS="--volume $2"
	    shift 2
	    ;;
	*)
	    unknown flag "$1"
	    exit 1
	    ;;
    esac
done

SOURCE=$1
ATEMP="${SOURCE%.*}"-$$.ac3
AINPUT="${ATEMP}"
VTEMP="${SOURCE%.*}"-$$.mkv
OUTPUT="${SOURCE%.*}"-NTSC.mkv

INRATE=$(mediainfo "--Inform=Video;%FrameRate%" "${SOURCE}")
OUTRATE=$(python -c "print '%.3f' % (24000.0 / 25025 * $INRATE)")

mkvmerge -o "${VTEMP}" --default-duration 0:${OUTRATE}fps -d 0 "${SOURCE}"
ffmpeg -loglevel quiet -y -i "${SOURCE}" -vn -acodec ac3 -ab 448k -filter:a asetpts='25025/24000*(PTS-STARTPTS)',aresample=48000:min_comp=0.01:comp_duration=1:max_soft_comp=100000000:min_hard_comp=0.3 "${ATEMP}"

if [ -n "${NORMALIZE}" ] ; then
    adjust-volume ${ADJFLAGS} "${ATEMP}"
    AINPUT="${ATEMP%.*}"-adj.ac3
fi

mkvmerge -o "${OUTPUT}" -A "${VTEMP}" "${AINPUT}"
edit-chapters --fix --multiplier 1.043 "${OUTPUT}"

rm -rf "${ATEMP}" "${VTEMP}" "${AINPUT}"
